<?php

namespace App\Http\Controllers;

use App\Models\EndorsementActivity;
use App\Models\Tier2Endorsement;
use App\Models\User;
use App\Models\Course;
use App\Services\VatEudService;
use App\Services\VatsimActivityService;
use App\Services\ActivityLogger;
use App\Services\MoodleService;
use Illuminate\Http\Request;
use Illuminate\Log\Logger;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Cache;
use Inertia\Inertia;
use Inertia\Response;
use Carbon\Carbon;

class EndorsementController extends Controller
{
    protected VatEudService $vatEudService;
    protected VatsimActivityService $activityService;
    protected MoodleService $moodleService;

    public function __construct(
        VatEudService $vatEudService,
        VatsimActivityService $activityService,
        MoodleService $moodleService
    ) {
        $this->vatEudService = $vatEudService;
        $this->activityService = $activityService;
        $this->moodleService = $moodleService;
    }

    public function traineeView(Request $request): Response
    {
        $user = $request->user();
        
        if (!$user->isVatsimUser()) {
            return Inertia::render('endorsements/trainee', [
                'tier1Endorsements' => [],
                'tier2Endorsements' => [],
                'soloEndorsements' => [],
                'isVatsimUser' => false,
            ]);
        }

        try {
            $tier1Data = $this->getUserTier1Endorsements($user->vatsim_id);
            $tier2Data = $this->getUserTier2Endorsements($user->vatsim_id);
            $soloData = $this->getUserSoloEndorsements($user->vatsim_id);

            return Inertia::render('endorsements/trainee', [
                'tier1Endorsements' => $tier1Data,
                'tier2Endorsements' => $tier2Data,
                'soloEndorsements' => $soloData,
                'isVatsimUser' => true,
            ]);
        } catch (\Exception $e) {
            Log::error('Error loading endorsements', [
                'user_id' => $user->id,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            
            return Inertia::render('endorsements/trainee', [
                'tier1Endorsements' => [],
                'tier2Endorsements' => [],
                'soloEndorsements' => [],
                'isVatsimUser' => true,
                'error' => 'Failed to load endorsement data',
            ]);
        }
    }

    public function mentorView(Request $request): Response
    {
        $user = $request->user();

        if (!$user->isMentor() && !$user->is_superuser) {
            abort(403, 'Access denied. Mentor privileges required.');
        }

        if ($user->is_superuser || $user->is_admin) {
            $allowedPositions = null;
            $canRemovePositions = null;
        } else {
            $mentorPositions = $user->mentorCourses
                ->flatMap(function (Course $course) {
                    $airport = $course->airport_icao;
                    $position = $course->position;

                    if ($position === 'GND') {
                        return ["{$airport}_GNDDEL"];
                    }

                    return ["{$airport}_{$position}"];
                })
                ->unique()
                ->values();

            $cotPositions = $user->chiefOfTrainingCourses
                ->flatMap(function (Course $course) {
                    $airport = $course->airport_icao;
                    $position = $course->position;
    
                    if ($position === 'GND') {
                        return ["{$airport}_GNDDEL"];
                    }
    
                    return ["{$airport}_{$position}"];
                })
                ->unique()
                ->values();

            $lmPositions = collect([]);
            $lmFirs = $user->leadingMentorFirs()->pluck('fir');


            if ($lmFirs->isNotEmpty()) {
                foreach ($lmFirs as $fir) {
                    $firCourses = Course::whereHas('mentorGroup', function ($query) use ($fir) {
                        $query->where('name', 'LIKE', "%{$fir}%");
                    })->get();

                    $firPositions = $firCourses->flatMap(function (Course $course) {
                        $airport = $course->airport_icao;
                        $position = $course->position;

                        if ($position === 'GND') {
                            return ["{$airport}_GNDDEL"];
                        }

                        return ["{$airport}_{$position}"];
                    });

                    $lmPositions = $lmPositions->merge($firPositions);
                }

                $lmPositions = $lmPositions->unique()->values();
            }

            $allowedPositions = $mentorPositions
                ->merge($cotPositions)
                ->merge($lmPositions)
                ->unique()
                ->values();

            $canRemovePositions = $cotPositions
                ->merge($lmPositions)
                ->unique()
                ->values();
        }

        $allTier1 = $this->vatEudService->getTier1Endorsements();

        $endorsementIds = collect($allTier1)->pluck('id')->toArray();
        $vatsimIds = collect($allTier1)->pluck('user_cid')->unique()->toArray();

        $activities = EndorsementActivity::whereIn('endorsement_id', $endorsementIds)
            ->get()
            ->keyBy('endorsement_id');

        $users = User::whereIn('vatsim_id', $vatsimIds)
            ->get()
            ->keyBy('vatsim_id');

        $lmFirs = $user->is_superuser || $user->is_admin ? collect() : $user->leadingMentorFirs()->pluck('fir');

        $endorsements = collect($allTier1)
            ->map(function ($endorsement) use ($activities, $users) {
                $activity = $activities->get($endorsement['id']);
                if (!$activity) {
                    return null;
                }

                $createdAt = Carbon::parse($endorsement['created_at']);
                $olderThanSixMonths = $createdAt->lte(now()->subMonths(6));
                $hasGoodActivity = $activity->activity_hours >= 3;
                $shouldBeVisible = $hasGoodActivity || $olderThanSixMonths;

                if (!$shouldBeVisible) {
                    return null;
                }

                $user = $users->get($endorsement['user_cid']);

                return [
                    'id' => $activity->id,
                    'endorsementId' => $endorsement['id'],
                    'position' => $endorsement['position'],
                    'vatsimId' => $endorsement['user_cid'],
                    'userName' => $user?->name ?? 'Unknown',
                    'activity' => $activity->activity_minutes,
                    'activityHours' => $activity->activity_hours,
                    'status' => $activity->status,
                    'progress' => $activity->progress,
                    'removalDate' => $activity->removal_date?->format('Y-m-d'),
                    'removalDays' => $activity->removal_date
                        ? $activity->removal_date->diffInDays(now(), false)
                        : -1,
                    'eligibleForRemoval' => $olderThanSixMonths,
                    'endorsedAt' => $createdAt->format('Y-m-d'),
                ];
            })
            ->filter()
            ->filter(function ($endorsement) use ($allowedPositions, $user, $lmFirs) {
                if ($user->is_superuser || $user->is_admin) {
                    return true;
                }

                if ($allowedPositions === null || $allowedPositions->isEmpty()) {
                    if ($lmFirs->isNotEmpty()) {
                        return $this->endorsementMatchesLeadingMentorFir($endorsement['position'], $lmFirs);
                    }
                    return false;
                }

                if ($allowedPositions->contains($endorsement['position'])) {
                    return true;
                }

                if ($lmFirs->isNotEmpty()) {
                    return $this->endorsementMatchesLeadingMentorFir($endorsement['position'], $lmFirs);
                }

                return false;
            })
            ->values();

        $endorsementsByPosition = $endorsements
            ->groupBy('position')
            ->map(function ($items, $position) {
                return [
                    'position' => $position,
                    'position_name' => $this->getPositionFullName($position),
                    'airport_icao' => explode('_', $position)[0],
                    'position_type' => $this->getPositionType($position),
                    'endorsements' => $items->values(),
                ];
            })
            ->values();

        $canRemovePositions = null;
        if (!($user->is_superuser || $user->is_admin)) {
            $canRemovePositions = $endorsements
                ->pluck('position')
                ->unique()
                ->filter(function ($position) use ($user, $lmFirs) {
                    $allCourses = $this->getAllCoursesForPosition($position);

                    if ($allCourses->isEmpty()) {
                        if ($lmFirs->isNotEmpty()) {
                            $result = $this->endorsementMatchesLeadingMentorFir($position, $lmFirs);
                            return $result;
                        }
                        return false;
                    }

                    $isCoTOrLM = false;
                    foreach ($allCourses as $course) {
                        $canManage = $user->canManageEndorsementsFor($course);

                        if ($canManage) {
                            $isCoTOrLM = true;
                            break;
                        }
                    }

                    if ($isCoTOrLM) {
                        return true;
                    }

                    $hasAnyCoT = \DB::table('chief_of_trainings')
                        ->whereIn('course_id', $allCourses->pluck('id'))
                        ->exists();

                    if (!$hasAnyCoT) {
                        $isMentorForAnyCourse = $allCourses->contains(function ($course) use ($user) {
                            $isMentor = $user->mentorCourses()->where('courses.id', $course->id)->exists();

                            return $isMentor;
                        });

                        if ($isMentorForAnyCourse) {
                            return true;
                        }
                    }

                    if ($lmFirs->isNotEmpty()) {
                        $result = $this->endorsementMatchesLeadingMentorFir($position, $lmFirs);
                        return $result;
                    }

                    return false;
                })
                ->values()
                ->toArray();
        }
        return Inertia::render('endorsements/manage', [
            'endorsementGroups' => $endorsementsByPosition,
            'userPermissions' => [
                'canRemoveForPositions' => $canRemovePositions,
                'canRemoveAny' => ($user->is_superuser || $user->is_admin) || (!empty($canRemovePositions) && count($canRemovePositions) > 0),
            ],
        ]);
    }

    protected function findCourseByPosition(string $position): ?Course
    {
        $parts = explode('_', $position);
        if (count($parts) < 2) {
            return null;
        }

        $airportIcao = $parts[0];

        if (count($parts) > 2 && $parts[1] === 'GNDDEL') {
            $positionType = 'GND';
        } else {
            $positionType = $parts[1];
        }

        return Course::where('airport_icao', $airportIcao)
            ->where('position', $positionType)
            ->first();
    }

    protected function getAllCoursesForPosition(string $position): \Illuminate\Support\Collection
    {
        $parts = explode('_', $position);
        if (count($parts) < 2) {
            return collect();
        }

        $airportIcao = $parts[0];

        if ($parts[1] === 'GNDDEL' || (count($parts) > 2 && in_array('GNDDEL', $parts))) {
            $positionType = 'GND';
        } else {
            $positionType = $parts[1];
        }

        return Course::where('airport_icao', $airportIcao)
            ->where('position', $positionType)
            ->get();
    }

    protected function endorsementMatchesLeadingMentorFir(string $position, $lmFirs): bool
    {
        $positionUpper = strtoupper($position);

        foreach ($lmFirs as $fir) {
            $firUpper = strtoupper($fir);

            if (str_contains($positionUpper, $firUpper)) {
                return true;
            }

            $firNameMap = [
                'EDWW' => ['BREMEN', 'EDWW'],
                'EDGG' => ['LANGEN', 'EDGG'],
                'EDMM' => ['MÜNCHEN', 'MUNICH', 'EDMM'],
            ];

            if (isset($firNameMap[$firUpper])) {
                foreach ($firNameMap[$firUpper] as $keyword) {
                    if (str_contains($positionUpper, $keyword)) {
                        return true;
                    }
                }
            }
        }

        return false;
    }

    public function removeTier1(Request $request, int $endorsementId)
    {
        $user = $request->user();

        if (!$user->isMentor() && !$user->is_superuser) {
            return back()->with('flash', [
                'error' => 'Access denied. Mentor privileges required.'
            ]);
        }

        $endorsement = EndorsementActivity::where('endorsement_id', $endorsementId)->first();

        if (!$endorsement) {
            Log::error('Error removing Tier 1 endorsement', [
                'tier1_id' => $endorsementId,
                'user_id' => $user->id,
                'error' => 'Endorsement not found'
            ]);
            return back()->with('flash', [
                'error' => 'Endorsement not found in the system.'
            ]);
        }

        if (!$user->is_superuser && !$user->is_admin) {
            $hasPermission = false;

            if ($user->canRemoveEndorsementForPosition($endorsement->position)) {
                $hasPermission = true;
            } else {
                $lmFirs = $user->leadingMentorFirs()->pluck('fir');
                if ($lmFirs->isNotEmpty() && $this->endorsementMatchesLeadingMentorFir($endorsement->position, $lmFirs)) {
                    $hasPermission = true;
                }
            }

            if (!$hasPermission) {
                Log::warning('Unauthorized endorsement removal attempt', [
                    'user_id' => $user->id,
                    'user_name' => $user->name,
                    'endorsement_id' => $endorsementId,
                    'position' => $endorsement->position,
                    'vatsim_id' => $endorsement->vatsim_id
                ]);

                return back()->with('flash', [
                    'error' => 'You do not have permission to manage this endorsement. Only Chief of Training or Leading Mentor for this position can remove endorsements.'
                ]);
            }
        }

        if ($endorsement->removal_date) {
            return back()->with('flash', [
                'error' => 'This endorsement is already marked for removal.'
            ]);
        }

        $endorsementCreatedAt = Carbon::parse(
            collect($this->vatEudService->getTier1Endorsements())
                ->firstWhere('id', $endorsementId)['created_at'] ?? null
        );

        if (!$endorsementCreatedAt || $endorsementCreatedAt->gt(now()->subMonths(6))) {
            return back()->with('flash', [
                'error' => 'Endorsement must be at least 6 months old before it can be removed.'
            ]);
        }

        $minRequiredMinutes = config('services.vateud.min_activity_minutes', 180);

        if ($endorsement->activity_minutes >= $minRequiredMinutes) {
            return back()->with('flash', [
                'error' => 'Endorsement has sufficient activity and cannot be marked for removal.'
            ]);
        }

        try {
            $endorsement->removal_date = Carbon::now()->addDays(
                config('services.vateud.removal_warning_days', 31)
            );
            $endorsement->removal_notified = false;
            $endorsement->last_updated = Carbon::createFromTimestamp(1);
            $endorsement->save();

            $trainee = User::where('vatsim_id', $endorsement->vatsim_id)->first();

            if ($trainee) {
                ActivityLogger::endorsementRemoved(
                    $endorsement->position,
                    $trainee,
                    $user,
                    'Marked for removal due to low activity'
                );
            }

            Log::info('Endorsement marked for removal', [
                'user_id' => $user->id,
                'user_name' => $user->name,
                'endorsement_id' => $endorsementId,
                'position' => $endorsement->position,
                'vatsim_id' => $endorsement->vatsim_id,
                'trainee_name' => $trainee?->name
            ]);

            return back()->with('flash', [
                'success' => "Successfully marked {$endorsement->position} for removal"
            ]);
        } catch (\Exception $e) {
            Log::error('Failed to mark endorsement for removal', [
                'endorsement_id' => $endorsementId,
                'user_id' => $user->id,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);

            return back()->with('flash', [
                'error' => 'An error occurred while marking the endorsement for removal. Please try again.'
            ]);
        }
    }

    public function requestTier2(Request $request, int $tier2Id)
    {
        $user = $request->user();
        
        if (!$user->isVatsimUser()) {
            return back()->with('error', 'VATSIM account required');
        }

        try {
            $tier2Endorsement = Tier2Endorsement::findOrFail($tier2Id);
            
            $existingTier2 = collect($this->vatEudService->getTier2Endorsements())
                ->where('user_cid', $user->vatsim_id)
                ->where('position', $tier2Endorsement->position)
                ->first();

            if ($existingTier2) {
                return back()->with('error', 'You already have this endorsement');
            }

            if ($tier2Endorsement->moodle_course_id) {
                $moodleCompleted = $this->moodleService->getCourseCompletion(
                    $user->vatsim_id,
                    $tier2Endorsement->moodle_course_id
                );

                if (!$moodleCompleted) {
                    return back()->with('error', 'You must complete the Moodle course before requesting this endorsement');
                }
            }
            
            $success = $this->vatEudService->createTier2Endorsement(
                $user->vatsim_id,
                $tier2Endorsement->position,
                config('services.vateud.atd_lead_cid', 1441619)
            );

            if (!$success) {
                return back()->with('error', 'Failed to create endorsement');
            }

            Cache::forget('vateud:tier2_endorsements');

            ActivityLogger::endorsementGranted(
                $tier2Endorsement->position,
                $user,
                $user,
                'tier2'
            );

            return redirect()->route('endorsements')->with('success', 'Tier 2 endorsement granted successfully');

        } catch (\Exception $e) {
            Log::error('Error requesting Tier 2 endorsement', [
                'tier2_id' => $tier2Id,
                'user_id' => $user->id,
                'error' => $e->getMessage()
            ]);

            return back()->with('error', 'An error occurred while requesting the endorsement');
        }
    }

    protected function getUserTier1Endorsements(int $vatsimId): array
    {
        $allTier1 = $this->vatEudService->getTier1Endorsements();
        $tier1Endorsements = collect($allTier1)->where('user_cid', $vatsimId);

        if ($tier1Endorsements->isEmpty()) {
            return [];
        }

        $endorsementIds = $tier1Endorsements->pluck('id')->toArray();

        $activities = EndorsementActivity::whereIn('endorsement_id', $endorsementIds)
            ->get()
            ->keyBy('endorsement_id');

        $result = [];

        foreach ($tier1Endorsements as $endorsement) {
            $activity = $activities->get($endorsement['id']);

            if (!$activity) {
                continue;
            }

            $lastActivityDate = $activity->last_activity_date
                ? $activity->last_activity_date->format('Y-m-d')
                : 'Never';

            $result[] = [
                'position' => $endorsement['position'],
                'fullName' => $this->getPositionFullName($endorsement['position']),
                'type' => $this->getPositionType($endorsement['position']),
                'activity' => $activity->activity_minutes,
                'activityHours' => $activity->activity_hours,
                'status' => $activity->status,
                'progress' => $activity->progress,
                'lastActivity' => $lastActivityDate,
                'removalDate' => $activity->removal_date?->format('Y-m-d'),
                'lastUpdated' => $activity->last_updated?->format('Y-m-d H:i'),
            ];
        }

        return $result;
    }

    protected function getUserTier2Endorsements(int $vatsimId): array
    {
        $tier2Endorsements = collect($this->vatEudService->getTier2Endorsements())
            ->where('user_cid', $vatsimId)
            ->pluck('position')
            ->toArray();

        $availableTier2 = Tier2Endorsement::all();
        $result = [];

        foreach ($availableTier2 as $endorsement) {
            $hasEndorsement = in_array($endorsement->position, $tier2Endorsements);
            $moodleCompleted = false;

            if (!$hasEndorsement && $endorsement->moodle_course_id) {
                $moodleCompleted = $this->moodleService->getCourseCompletion(
                    $vatsimId,
                    $endorsement->moodle_course_id
                );
            }

            $result[] = [
                'id' => $endorsement->id,
                'position' => $endorsement->position,
                'name' => $endorsement->name,
                'fullName' => $endorsement->name,
                'type' => $this->getPositionType($endorsement->position),
                'status' => $hasEndorsement ? 'active' : ($moodleCompleted ? 'completed' : 'available'),
                'moodleCourseId' => $endorsement->moodle_course_id,
                'hasEndorsement' => $hasEndorsement,
                'moodleCompleted' => $moodleCompleted,
            ];
        }

        return $result;
    }

    protected function getUserSoloEndorsements(int $vatsimId): array
    {
        $soloEndorsements = collect($this->vatEudService->getSoloEndorsements())
            ->where('user_cid', $vatsimId);

        $result = [];

        foreach ($soloEndorsements as $solo) {
            $expiresAt = null;

            if (!empty($solo['expiry'])) {
                try {
                    $expiresAt = Carbon::parse($solo['expiry'])->toDateString();
                } catch (\Exception) {
                    $expiresAt = null;
                }
            }

            $result[] = [
                'position' => $solo['position'],
                'fullName' => $this->getPositionFullName($solo['position']),
                'type' => $this->getPositionType($solo['position']),
                'status' => 'active',
                'mentor' => $this->getMentorName($solo['instructor_cid'] ?? null),
                'expiresAt' => $expiresAt,
            ];
        }

        return $result;
    }

    protected function getPositionFullName(string $position): string
    {
        $positionNames = [
            'EDDF_TWR' => 'Frankfurt Tower',
            'EDDF_APP' => 'Frankfurt Approach',
            'EDDF_GNDDEL' => 'Frankfurt Ground/Delivery',
            'EDDL_TWR' => 'Düsseldorf Tower',
            'EDDL_APP' => 'Düsseldorf Approach',
            'EDDL_GNDDEL' => 'Düsseldorf Ground/Delivery',
            'EDDK_TWR' => 'Köln Tower',
            'EDDK_APP' => 'Köln Approach',
            'EDDS_TWR' => 'Stuttgart Tower',
            'EDDH_TWR' => 'Hamburg Tower',
            'EDDH_APP' => 'Hamburg Approach',
            'EDDH_GNDDEL' => 'Hamburg Ground/Delivery',
            'EDDM_TWR' => 'München Tower',
            'EDDM_APP' => 'München Approach',
            'EDDM_GNDDEL' => 'München Ground/Delivery',
            'EDDB_APP' => 'Berlin Approach',
            'EDDB_TWR' => 'Berlin Tower',
            'EDDB_GNDDEL' => 'Berlin Ground/Delivery',
            'EDWW_CTR' => 'Bremen Big',
            'EDWW_W_CTR' => 'Bremen West',
            'EDGG_CSH_CTR' => 'Central South (High)',
            'EDXX_AFIS' => 'AFIS Tower',
        ];

        return $positionNames[$position] ?? $position;
    }

    protected function getPositionType(string $position): string
    {
        if (str_ends_with($position, '_CTR')) {
            return 'CTR';
        } elseif (str_ends_with($position, '_APP')) {
            return 'APP';
        } elseif (str_ends_with($position, '_TWR')) {
            return 'TWR';
        } elseif (str_ends_with($position, '_GNDDEL')) {
            return 'GNDDEL';
        }

        return 'TWR';
    }

    protected function getMentorName(?int $vatsimId): string
    {
        if (!$vatsimId) {
            return 'Unknown';
        }

        $user = User::where('vatsim_id', $vatsimId)->first();
        return $user ? $user->name : "ID: {$vatsimId}";
    }
}
